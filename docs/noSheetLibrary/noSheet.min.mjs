"use strict";export{TagCloud};class TagCloud{#tags=new Map;#ids=new Map;hasId(e){return this.#ids.has(e)}hasTag(e){return this.#tags.has(e)}add(e,t){for(const n of e)this.hasTag(n)||this.#tags.set(n,new Set),this.#tags.get(n).add(t);this.hasId(t)?e.forEach(e=>this.#ids.get(t).add(e)):this.#ids.set(t,new Set(e))}list(...t){if(!t?.length)return this.#ids.keys();let e=new Set;for(const n of t)(this.#tags.get(n)??[]).forEach(t=>e.add(t));return e.size==this.#ids.size?this.#ids.keys():this.#ids.keys().filter(t=>e.has(t))}upsert(e,t){return this.hasId(e)?this.update(e,t):(this.add(t,e),!0)}update(e,t){if(!this.hasId(e))throw new Error(`The unique id '${e}' does not exist`);let n=this.#ids.get(e).difference(new Set(t));return this.remove(e),this.add(t,e),n}remove(e){let t=this.#ids.get(e);this.#ids.delete(e);for(const n of t)this.#tags.get(n).delete(e),this.#tags.get(n).size||this.#tags.delete(n);return t}}export{createTable,defineStack};function validateArray(e){if(e&&!Array.isArray(e))throw new TypeError("Array expected")}function defineStack(...e){return TableFactory.create(e)}function createTable(e,...n){validateArray(e);let t=TableFactory.create(e);return t.addFacets(...n),t.createTable()}const noop=e=>{},allTagsSymbol=Symbol("all-tags"),rowUIDprop=Symbol("uid"),tablesProp=Symbol("tags");function isStdObjectProp(e){return!!Object.prototype[e]}function isStdObjectPropOrSymbol(e){return"symbol"==typeof e||isStdObjectProp(e)}function isFunction(e){return typeof e=="function"}function isArrowFunction(e){return isFunction(e)&&0[0]===e.prototype}function isIterable(e){return e!=null&&typeof e[Symbol.iterator]=="function"}const registration_handler={get:(e,t)=>{throw new Error(`${t} getter is not allowed in this context`)},set:(e,t,n)=>{if(typeof n!="function"||0[0]!==n.prototype)throw new Error(`${t} is not an arrow function`);if(e.hasFunction(t))throw new Error(`${t} is already defined`);return e.registerFunction(t),!0}};function getRegistrationHandler(e){return new Proxy(e,registration_handler)}const isObject=e=>e!=null&&typeof e=="object";class ReadOnlyProxyWriteError extends Error{}const ReadOnlyProxyDescriptor={get:(e,t)=>{let n=e[t];return isObject(n)?readonly(n):n},set:()=>{throw new ReadOnlyProxyWriteError("Cannot write on read-only proxy")},deleteProperty:()=>{throw new ReadOnlyProxyWriteError("Cannot delete on read-only proxy")}},readonly=e=>new Proxy(e,ReadOnlyProxyDescriptor);class TableFactory{static#factories=new Map;static#ident=Symbol("ident");get ident(){return TableFactory.#ident}static isTypeOfMe(e){return TableFactory.#ident===e.ident}static create(e){let t=new TableFactory(e);return new Proxy(t,{get:(e,n,s)=>{if(t.#consolidation_aggregates.has(n))return t.#consolidation_aggregates.get(n);const o=e[n];return o instanceof Function?function(...t){return o.apply(this===s?e:this,t)}:o}})}#id;#table_counter=0;#tag_cloud=new TagCloud;#table_interfaces=new Map;#num_data_columns;#column_names;#column_indexes;#aggregates=new Map;#facets=[];#reference_facets=new Map;#default_reference_facet;#dependencies=new Set;#consolidation_aggregates=new Map;#consolidation_aggregate_indexes=new Map;#current_aggregate_index;#consolidation_reference_facet;#consolidation_references=new Map;#consolidation_reference_handles=new Map;#consolidators=[];static#throw_invalid_aggregate_error=e=>{throw new Error(`Invalid consolidation aggregate: '${e}'`)};static#throw_invalid_reference_error=e=>{throw new Error(`Invalid consolidation reference: '${e}'`)};#hooks=new Map([["beforeConsolidation",[]],["afterConsolidation",[]]]);constructor(e=[]){this.#id=Symbol(`s${TableFactory.#factories.size+1}`),this.#num_data_columns=e.length,this.#column_names=e.slice(),this.#column_indexes=new Map(e.map(t=>[t,e.indexOf(t)])),TableFactory.#factories.set(this.#id,this)}id(){return this.#id}createTable(...s){let e=Symbol(`${this.#id.description}.T${++this.#table_counter}`),t=new Table(e,this),n=t.publicInterface;return this.#table_interfaces.set(e,{table:t,proxied_table:n,sheet:this.#id}),this.#tag_cloud.add([...s,e],e),n}detachTable(e,t){this.#table_interfaces.delete(e),this.#tag_cloud.remove(e),this.#reference_facets.keys().filter(e=>!e.reference_count).forEach(e=>this.#reference_facets.delete(e)),t&&this.doConsolidation()}setDefaultReferences(e){if(isArrowFunction(e))throw new Error("Arrow functions are not supported");e.reference_count=1,e.is_default=!0,this.#reference_facets.set(e,this.#registerReferences(e)),this.#default_reference_facet=e}resolveReferences(e){return new Map([...this.#reference_facets.get(this.#default_reference_facet)??new Map,...this.#reference_facets.get(e)??new Map])}getUniqueTable(...e){let t=[...[...this.#tag_cloud.list(...e)].map(e=>this.#table_interfaces.get(e).proxied_table)];if(t.length>1)throw new Exception(`Multiple tables match tags: ${e}`);return t.pop()}tables(...t){let e=this;const n={aggregates(...n){let s=[...e.#tag_cloud.list(...t)].map(t=>e.#table_interfaces.get(t).table);return 1==n.length?s.map(e=>e.getAttribute(n[0])):(n.length||(n=e.#aggregates.keys()),{*[Symbol.iterator](){for(const e of n)yield s.map(t=>t.getAttribute(e))}})},setReferences(n){if(isArrowFunction(n))throw new Error("Arrow functions are not supported");n.reference_count=0,e.#reference_facets.set(n,e.#registerReferences(n)),e.#tag_cloud.list(...t).forEach(t=>e.#table_interfaces.get(t).table._setReferenceFacet(n))},getReferenceHandle(n,s){let o={["valueOf"](){return Reflect.get(target,"value")},set:(s,o,i)=>(Reflect.set(s,o,i),"value"==o&&(e.#tag_cloud.list(...t).forEach(t=>e.#table_interfaces.get(t).table._setReferenceHandleValue(n,i)),this.calculate()),!0)};return e.#tag_cloud.list(...t).forEach(t=>e.#table_interfaces.get(t).table._setReferenceHandleValue(n,s)),new Proxy({value:s},o)},beforeCalculate(...n){e.#tag_cloud.list(...t).forEach(t=>e.#table_interfaces.get(t).table.beforeCalculate(...n))},calculate(){e.updateReferences(),e.#tag_cloud.list(...t).forEach(t=>e.#table_interfaces.get(t).table.executeFacets()),e.doConsolidation()},afterCalculate(...n){e.#tag_cloud.list(...t).forEach(t=>e.#table_interfaces.get(t).table.afterCalculate(...n))},detach(){e.#tag_cloud.list(...t).forEach(t=>e.#table_interfaces.get(t).table.detach(t,!1)),e.doConsolidation()},[Symbol.iterator](){let n=e.#tag_cloud.list(...t);return{next(){let t=n.next();return t.done||(t.value=e.#table_interfaces.get(t.value).proxied_table),t},return(){return{done:!0}}}}};return new Proxy(n,{get:(t,n,s)=>e.#aggregates.has(n)?t.aggregates(n):Reflect.get(t,n,s)})}getTableByInternalId(e){return this.#table_interfaces.get(e)?.proxied_table}get facets(){return this.#facets.values()}get dataColumnNames(){return this.#column_names.slice(0,this.#num_data_columns)}get columnNames(){return this.#column_names.values()}get calculatedColumnNames(){return this.#column_names.slice(this.#num_data_columns)}get aggregateNames(){return this.#aggregates.keys()}hasColumn(e){return this.#column_indexes.has(e)}columnIndex(e){return this.#column_indexes.get(e)}hasAggregate(e){return this.#aggregates.has(e)}aggregateIndex(e){return this.#aggregates.get(e)}get consolidationAggregates(){return new Map(this.#consolidation_aggregates)}#table_registrar={hasFunction:e=>this.#aggregates.has(e),registerFunction:e=>this.#aggregates.set(e,this.#aggregates.size)};#row_registrar={hasFunction:e=>this.#column_names.indexOf(e)!==-1,registerFunction:e=>{this.#column_names.push(e),this.#column_indexes.set(e,this.#column_indexes.size)}};#registration_bind=new Proxy({},{get:(e,t)=>{if(t==="facetInterfaces")return e=>[];throw new Error("__this__ is not valid outside of a facet row or aggregate function")}});addFacets(...e){let t=getRegistrationHandler(this.#table_registrar),n=getRegistrationHandler(this.#row_registrar);for(const s of e){if(isArrowFunction(s))throw new Error("Arrow functions are not supported");s.bind(this.#registration_bind)(t,n,Object.freeze({}))}this.#facets.push(...e)}#consolidation_aggregate_registrar={hasFunction:e=>this.#consolidation_aggregate_indexes.has(e),registerFunction:e=>this.#consolidation_aggregate_indexes.set(e,this.#consolidation_aggregate_indexes.size)};consolidate(e=[],...t){typeof e=="function"&&(t.unshift(e),e=[allTagsSymbol]);let n=getRegistrationHandler(this.#consolidation_aggregate_registrar);for(const e of t)e.bind(n,Object.freeze({}))();this.#consolidators.push([e,t])}#hasAggregateBeenCalculated(e){return this.#consolidation_aggregate_indexes.has(e)&&this.#current_aggregate_index>=(this.#consolidation_aggregate_indexes.get(e)??Number.MAX_SAFE_INTEGER)}#consolidation_handler={get:(e,t)=>{if(this.#hasAggregateBeenCalculated(t))return this.#consolidation_aggregates.get(t);if(Reflect.has(e,t))return Reflect.get(e,t,receiver);TableFactory.#throw_invalid_aggregate_error(t)},set:(e,t,n)=>(this.#current_aggregate_index++,this.#consolidation_aggregates.set(t,n()),!0)};#consolidation_proxy=new Proxy({},this.#consolidation_handler);#factory_tables_handler={get:(e,t,n)=>"symbol"==typeof t?Reflect.get(e,t,n):this.hasAggregate(t)?e[tablesProp].map(e=>e[t]):Reflect.get(e,t,n),apply:(e,t,n)=>{let o=n.filter(e=>!this.hasColumn(e));if(o.length)throw new Error(`The following columns are not defined: ${o}`);let i=e=>this.columnIndex(e),a=[],s=new Set;return{ordered_columns:n.toSorted((e,t)=>i(e)-i(t)),columns:new Map(n.reduce((e,t)=>[...e,[t,e.length]],[])),isEmpty(){for(const e of this)return!1;return!0},*[Symbol.iterator](){delete this.where,delete this.from;for(const t of e[tablesProp])yield[...t.select(...n).from(...s).where(...a)]},from(...e){return e.forEach(s.add,s),this},where(...e){return a.push(...e),this}}}};#consolidation_reference_handler={get:(e,t)=>this.#consolidation_reference_handles.has(t)?this.#consolidation_reference_handles.get(t):this.#consolidation_references?.get(t)??TableFactory.#throw_invalid_reference_error(t)};#consolidation_reference_proxy=Object.preventExtensions(new Proxy({},this.#consolidation_reference_handler));#processConsolidationFacets(e,t){let n=(t=>{let n=(...e)=>{};return n[tablesProp]=[...this.tables(...e)],n})(),s=new Proxy(n,this.#factory_tables_handler);t.forEach(e=>e.bind(this.#consolidation_proxy,s,this.#consolidation_reference_proxy)())}doConsolidation(){this.updateConsolidationReferences(),this.#executeHooks("beforeConsolidation"),this.#current_aggregate_index=-1;try{this.#consolidators.forEach(([e,t])=>{this.#processConsolidationFacets(e[0]===allTagsSymbol?[]:e,t)})}finally{this.#current_aggregate_index=0[0]}this.#executeHooks("afterConsolidation"),this.#dependencies.values().forEach(e=>e.tables().calculate()),this.#executeHooks("afterDependents")}updateConsolidationReferences(){if(!this.#consolidation_reference_facet)return;let t={set:(e,t,n)=>(e.set(t,n),!0),get:()=>{throw new Error("Invalid operation")}},e=new Map,n=new Proxy(e,t);this.#consolidation_reference_facet.bind(n)(e=>this.#handleConsolidationAggregateProperties(e)),this.#consolidation_references=e}setConsolidationReferences(e){if(isArrowFunction(e))throw new Error("Arrow functions are not supported");this.#consolidation_reference_facet=e,this.#consolidation_references=this.#registerReferences(e)}#setConsolidationReferenceHandleValue(e,t){this.#consolidation_reference_handles.set(e,t)}getConsolidationReferenceHandle(e,t){let n={["valueOf"](){return Reflect.get(target,"value")},set:(t,n,s)=>(Reflect.set(t,n,s),"value"==n&&(this.#setConsolidationReferenceHandleValue(e,s),this.doConsolidation()),!0)};return this.#setConsolidationReferenceHandleValue(e,t),new Proxy({value:t},n)}#executeHooks(e){(this.#hooks.get(e)??[]).forEach(e=>e())}#setHook(e,t){this.#hooks.get(e).push(...t)}beforeConsolidation(...e){this.#setHook("beforeConsolidation",e)}afterConsolidation(...e){this.#setHook("afterConsolidation",e)}#getFactoryWithSheetId(e){return TableFactory.#factories.values().find(t=>t.getTableByInternalId(e))}#registerReferences(e){let t=new Set,n=new Set,s={set:(e,t)=>(e.add(t),!0),get:()=>{throw new Error("Invalid operation")}},o=new Proxy(n,s);return e.bind(o)(e=>{if(this.#table_interfaces.has(e.id()))throw new Error("Self referencing table");if(this.#id===e.id())throw new Error("Self referencing sheet");return TableFactory.isTypeOfMe(e)?t.add(e):t.add(this.#getFactoryWithSheetId(e.id())),Object.freeze(new Proxy({},{get(){return noop}}))}),t.values().forEach(e=>e.addDependency(this)),n}addDependency(e){let t=new Set([this.#id]),n=new Set([...this.#dependencies.values().map(e=>e.id()),e.id()]),s=this.#id;for(const e of n){if(t.has(e))throw new Error("Circular reference detected");t.add(e),TableFactory.#factories.get(e).#dependencies.forEach(e=>n.add(e.id())),s=e}this.#dependencies.add(e)}#reference_consolidation_handler={get:(e,t)=>e[t]};#handleConsolidationAggregateProperties(e){return TableFactory.isTypeOfMe(e)?Object.preventExtensions(new Proxy(e,this.#reference_consolidation_handler)):e}updateReferences(){let e={set:(e,t,n)=>(e.set(t,n),!0),get:()=>{throw new Error("Invalid operation")}};this.#reference_facets.keys().forEach(t=>{let n=new Map,s=new Proxy(n,e);t.bind(s)(e=>this.#handleConsolidationAggregateProperties(e)),this.#reference_facets.set(t,n)})}}class Table{#id;#sheet_factory;#ticks=0;#calculating=!1;#rows=[];#attributes=new Map;#reference_facet;#reference_handles=new Map;#cells=new TableRows(this.#rows);#beforeCalculate=[];#afterCalculate=[];#current_column_index;#current_aggregate_index;constructor(e,t){this.#id=e,this.#sheet_factory=t}id(){return this.#id}ticks(){return this.#ticks}detach(e=!0){this.#reference_facet&&this.#reference_facet.reference_count--,this.#sheet_factory.detachTable(this.#id,e)}getAttribute(e){return this.#attributes.get(e)}get publicInterface(){return new Proxy(this,{get:(e,t,n)=>{const s=e[t];return s instanceof Function?function(...t){return s.apply(this===n?e:this,t)}:this.#attributes.get(t)},set:()=>{throw new Error("Tables are read only")}})}#isValidColumnDuringFacetCalculation(e){return this.#sheet_factory.hasColumn(e)&&this.#current_column_index>(this.#sheet_factory.columnIndex(e)??Number.MAX_SAFE_INTEGER)}#hasAggregateBeenCalculated(e){return this.#sheet_factory.hasAggregate(e)&&this.#current_aggregate_index>=(this.#sheet_factory.aggregateIndex(e)??Number.MAX_SAFE_INTEGER)}static#throw_column_error=e=>{throw new Error(`Column '${e}' doesn't exist`)};static#throw_invalid_column_error=e=>{throw new Error(`Invalid column: '${e}'`)};static#throw_invalid_aggregate_error=e=>{throw new Error(`Invalid aggregate: '${e}'`)};static#throw_invalid_reference_error=e=>{throw new Error(`Invalid reference: '${e}'`)};columnIterator(e=0){return this.columns(e)}column(e=0){return[...this.columnIterator(e)]}columnsIterator(...e){if(!e.length)return[];let t=e.filter(e=>!this.#isValidColumnDuringFacetCalculation(e));if(t.length)throw new Error(`Invalid columns: ${t}`);return this.select(...e)}columns(...e){return[...this.columnsIterator(...e)]}select(...e){let r=e.filter(e=>!this.#sheet_factory.hasColumn(e));if(r.length)throw new Error(`The following columns are not defined: ${r}`);let n=e=>this.#sheet_factory.columnIndex(e),t=this,s=[],o=new Set,i=Symbol("false"),a;const c={get:(e,t,n)=>{if(t===Symbol.toPrimitive&&console.warn(`Converting select_filter_proxy to primative.
Possible causes are not specifiying columns in a where() clause, e.g. select('column').where( v => __v__ == ...)?`),isStdObjectPropOrSymbol(t))return Reflect.get(e,t,n);let s=isNaN(+t)?this.#sheet_factory.columnIndex(t):t;return this.#rows[a][s]??Table.#throw_column_error(t)}},l=Object.preventExtensions(new Proxy({},c)),d={ordered_columns:e.toSorted((e,t)=>n(e)-n(t)),columns:new Map(e.reduce((e,t)=>[...e,[t,e.length]],[])),isEmpty(){for(const e of this)return!1;return!0},*[Symbol.iterator](){delete this.where,delete this.from;for(a of t.#cells.forEachRowIndexInPopulations(...o)){let r=a,c=s.length?s.reduce((e,t)=>e===i||!1===t(e)?i:e,l):t.#rows[r];c!==i&&(e.length?1===e.length?yield t.#rows[r][n(e[0])]:yield e.reduce((e,s)=>[...e,t.#rows[r][n(s)]],[]):yield t.#rows[r])}},from(...e){return e.forEach(o.add,o),this},where(...e){return s.push(...e),this}};return d}#createDataReferenceInterface(e,t){let n=0[0];return{getRowReferences:t=>n||(n=this.getRows(e)),get removed_rows(){return t},*[Symbol.iterator](){yield n,yield t}}}load(e,t=0[0]){return this.#createDataReferenceInterface(this.#cells.load(e,t))}unload(e){return this.#createDataReferenceInterface([],this.#cells.unload(e))}replace(e,t=0[0]){return this.#createDataReferenceInterface(...this.#cells.replace(e,t))}prepend(e,t,n=0[0]){return this.#createDataReferenceInterface(this.#cells.prepend(e,t,n))}append(e,t,n=0[0]){return this.#createDataReferenceInterface(this.#cells.append(e,t,n))}_setReferenceHandleValue(e,t){this.#reference_handles.set(e,t)}getReferenceHandle(e,t){let n={["valueOf"](){return Reflect.get(target,"value")},set:(t,n,s)=>(Reflect.set(t,n,s),"value"==n&&(this._setReferenceHandleValue(e,s),this.calculate()),!0)};return this._setReferenceHandleValue(e,t),new Proxy({value:t},n)}#RowReferenceHandler={get:(e,t,n)=>(this.#sheet_factory.hasColumn(t)&&(t=""+this.#sheet_factory.columnIndex(t)),Reflect.get(e,t,n)),set:(e,t,n)=>(Reflect.set(e,t,n),this.calculate(),!0)};getRow(e){return Number.isInteger(e)?new Proxy(this.#cells.getRow(e),this.#RowReferenceHandler):0[0]}getRows(e){return e.map(e=>this.getRow(e))}setRowCellValue(e,t,n,s=!0){this.#rows[e][t]=n,s&&this.calculate()}getPopulationRows(...e){return this.getRows(this.#cells.getPopulationRowUids(...e))}getTableRows(){return readonly(this.#rows)}_setReferenceFacet(e){this.#reference_facet=e,this.#reference_facet.reference_count++}setReferences(e){this.#sheet_factory.tables(this.#id).setReferences(e)}beforeCalculate(...e){this.#beforeCalculate.push(...e)}afterCalculate(...e){this.#afterCalculate.push(...e)}#aggregate_handler={get:(e,t)=>{if(this.#hasAggregateBeenCalculated(t))return this.#attributes.get(t);if(Reflect.has(e,t))return Reflect.get(e,t,receiver);Table.#throw_invalid_aggregate_error(t)},set:(e,t,n)=>(this.#current_aggregate_index++,this.#attributes.set(t,n()),!0)};#aggregate_proxy=new Proxy({},this.#aggregate_handler);#current_proxy_row_index=0;#row_handler={get:(e,t,n)=>{if(t==="constructor"||typeof t=="symbol")return Reflect.get(e,t,n);if(this.#isValidColumnDuringFacetCalculation(t))return this.#rows[this.#current_proxy_row_index][this.#sheet_factory.columnIndex(t)];if(Reflect.has(e,t))return Reflect.get(e,t,n);Table.#throw_invalid_column_error(t)},set:(e,t,n)=>{for(this.#current_proxy_row_index=0;this.#current_proxy_row_index<this.#rows.length;this.#current_proxy_row_index++)this.#rows[this.#current_proxy_row_index][this.#current_column_index]=n();return this.#current_column_index++,this.#current_proxy_row_index=-1,!0}};#row_proxy=new Proxy({},this.#row_handler);#reference_handler={get:(e,t)=>this.#reference_handles.has(t)?this.#reference_handles.get(t):this.#sheet_factory.resolveReferences(this.#reference_facet)?.get(t)??Table.#throw_invalid_reference_error(t)};#reference_proxy=Object.preventExtensions(new Proxy({},this.#reference_handler));#calculation_handler={get:(e,t,n)=>typeof t!="function"?Reflect.get(e,t,n):0};#calculation_proxy=Object.preventExtensions(new Proxy({column:e=>this.column(e),columns:(...e)=>this.columns(...e),facetInterfaces:()=>[this.column.bind(this),this.columns.bind(this)]},this.#calculation_handler));executeFacets(){this.#beforeCalculate.forEach(e=>e(this.#sheet_factory.getTableByInternalId(this.#id))),this.#current_aggregate_index=-1,this.#current_column_index=this.#sheet_factory.dataColumnNames.length,this.#calculating=!0;try{this.#sheet_factory.facets.forEach(e=>{e.bind(this.#calculation_proxy,this.#aggregate_proxy,this.#row_proxy,this.#reference_proxy)()})}finally{this.#calculating=!1,this.#current_aggregate_index=0[0],this.#current_column_index=0[0]}this.#ticks++,this.#afterCalculate.forEach(e=>e(this.#sheet_factory.getTableByInternalId(this.#id)))}calculate(){this.#sheet_factory.updateReferences(),this.executeFacets(),this.#sheet_factory.doConsolidation()}dataColumnNames(){return this.#sheet_factory.dataColumnNames}calculatedColumnNames(){return this.#sheet_factory.calculatedColumnNames}columnNames(){return this.#sheet_factory.columnNames}hasColumn(e){return this.#sheet_factory.hasColumn(e)}columnIndex(e){return this.#sheet_factory.columnIndex(e)}hasAggregate(e){return this.#sheet_factory.hasAggregate(e)}aggregateIndex(e){return this.#sheet_factory.aggregateIndex(e)}}class TableRows{static#default="default";#dataset;#populations;#references=[];#last_population;constructor(e=[],t=new Map){e.forEach((e,t)=>Object.defineProperty(e,rowUIDprop,{value:t})),this.#dataset=e,this.#populations=t,this.#references.push(...this.#dataset)}#RowReferenceHandler={set:(e,t,n)=>{let s=Reflect.get(e,rowUIDprop);if(!(s in this.#references))throw new Error(`Row::set uid(${s}) no longer exists`);return this.#references[s][t]=n,!0},get:(e,t,n)=>{if(isFunction(e[t])||isStdObjectPropOrSymbol(t))return Reflect.get(e,t,n);let s=Reflect.get(e,rowUIDprop);if(!(s in this.#references))throw new Error(`Row::get uid(${s}) no longer exists`);return this.#references[s][t]}};getRow(e){return new Proxy({[Symbol.iterator]:this.#references[e][Symbol.iterator],[rowUIDprop]:e,exists:t=>e in this.#references},this.#RowReferenceHandler)}getPopulationRowUids(...e){return this.forEachRowIndexInPopulations(...e).map(e=>this.#dataset[rowUIDprop])}load(e,t=TableRows.#default){if(this.#last_population!=t&&this.#populations.get(t))throw new RangeError("Non-contiguous population loaded");let n=e.length,s=this.#dataset.length;if(!n)return;let o=[];return e.forEach((e,t)=>{Object.defineProperty(e,rowUIDprop,{value:t+this.#references.length}),o.push(e[rowUIDprop])}),this.#dataset.push(...e),this.#references.push(...e),this.#last_population==t&&([s,n]=this.#populations.get(t),n+=e.length),this.#populations.set(t,[s,n]),this.#last_population=t,o}unload(e=TableRows.#default){if(!this.#populations.get(e))return[];let[t,n]=this.#populations.get(e);this.#populations.delete(e);for(const[s,[e,o]]of this.#populations)e>t&&this.#populations.set(s,[e-n,o]);this.#last_population=Array.from(this.#populations.keys()).pop();let s=this.#dataset.splice(t,n);return s.forEach(e=>delete this.#references[e[rowUIDprop]]),s}replace(e,t=TableRows.#default){let[n,s]=this.#populations.get(t),a=e.length-s;this.#populations.set(t,[n,e.length]);for(const[t,[e,s]]of this.#populations)e>n&&this.#populations.set(t,[e+a,s]);let o=[];e.forEach((e,t)=>{Object.defineProperty(e,rowUIDprop,{value:t+this.#references.length}),o.push(e[rowUIDprop])}),this.#references.push(...e);let i=this.#dataset.splice(n,s,...e);return i.forEach(e=>delete this.#references[e[rowUIDprop]]),[o,i]}#insertRows(e,t,n=TableRows.#default,s=0[0]){let[o,i]=this.#populations.get(n),a=s==null||n==s,r=e?o:o+i,c=[];t.forEach((e,t)=>{Object.defineProperty(e,rowUIDprop,{value:t+this.#references.length}),c.push(e[rowUIDprop])}),this.#dataset.splice(r,0,...t),a?(i+=t.length,this.#populations.set(n,[o,i])):e&&(o+=t.length,this.#populations.set(n,[o,i]));for(const[e,[n,i]]of this.#populations)n>o&&e!==s&&this.#populations.set(e,[n+t.length,i]);return a||this.#populations.set(s,[r,t.length]),c}prepend(e,t=TableRows.#default,n=0[0]){return this.#insertRows(!0,e,t,n)}append(e,t,n=0[0]){return this.#insertRows(!1,e,t,n)}forEachRowIndexInPopulations(...e){if(!e?.length){let e=this.#dataset;return{*[Symbol.iterator](){for(let t=0;t<e.length;t++)yield t}}}let t=this;return{*[Symbol.iterator](){for(const[s,[n,o]]of t.#populations)if(e.indexOf(s)>=0)for(let e=n;e<n+o;e++)yield e}}}}